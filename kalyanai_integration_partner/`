import { useEffect, useState } from "react";

type Job = {
  id: string;
  filename: string;
  status: "uploaded" | "processing" | "done" | "error";
  createdAt: string;
  resultSummary?: string;
  analysisJson?: Record<string, unknown> | null;
  emailStatus?: string | null;
  emailSentAt?: string | null;
};

// Your backend on the VPS
const API_BASE_URL = "http://185.151.29.141:3001";

function getStatusBadgeClasses(status: Job["status"]): string {
  const base =
    "inline-flex items-center rounded-full px-2 py-0.5 text-[0.65rem] font-semibold tracking-wide uppercase border";

  switch (status) {
    case "uploaded":
      return `${base} bg-[#050B1F] text-[#9CA3AF] border-[#1F2933]`;
    case "processing":
      return `${base} bg-cyan-900/40 text-cyan-300 border-cyan-500/60`;
    case "done":
      return `${base} bg-emerald-900/40 text-emerald-300 border-emerald-500/60`;
    case "error":
      return `${base} bg-red-900/40 text-red-300 border-red-500/60`;
    default:
      return `${base} bg-[#050B1F] text-[#9CA3AF] border-[#1F2933]`;
  }
}

export default function Discovery() {
  const [status, setStatus] = useState("Idle - waiting for a recording.");
  const [file, setFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const [jobs, setJobs] = useState<Job[]>([]);
  const [selectedJob, setSelectedJob] = useState<Job | null>(null);
  const [selectedAnalysis, setSelectedAnalysis] = useState<
    Record<string, unknown> | null
  >(null);
  const [isDetailsLoading, setIsDetailsLoading] = useState(false);
  const [detailsError, setDetailsError] = useState<string | null>(null);
  const [showHistory, setShowHistory] = useState(false);
  const [lastUploadAt, setLastUploadAt] = useState<number | null>(null);

  const [isLoadingJobs, setIsLoadingJobs] = useState(false);

  const latestJob = jobs.length > 0 ? jobs[0] : null;

  const uploadErrorMessage =
    status.startsWith("Upload failed") ||
    status.startsWith("Please upload")
      ? status
      : null;

  const combinedErrorMessage = uploadErrorMessage ?? detailsError;

  let statusMessage = "Idle - waiting for a recording.";

  if (combinedErrorMessage) {
    statusMessage = combinedErrorMessage;
  } else if (isUploading) {
    statusMessage = "Uploading file - please wait...";
  } else if (
    latestJob &&
    (latestJob.status === "uploaded" || latestJob.status === "processing")
  ) {
    statusMessage =
      "File uploaded successfully. Analysis has started - this may take a few minutes. Check the Recent Calls list for status updates.";
  } else if (latestJob && latestJob.status === "done") {
    statusMessage =
      'Analysis complete. Call summary is ready - click "View details" in Recent Calls.';
  }

  const loadJobs = async () => {
    setIsLoadingJobs(true);
    try {
      const response = await fetch(`${API_BASE_URL}/jobs`);
      if (!response.ok) {
        setIsLoadingJobs(false);
        return;
      }
      const data: Job[] = await response.json();
      const normalized: Job[] = data.map((job) => {
        let parsedAnalysis: Record<string, unknown> | null = null;
        try {
          parsedAnalysis = job.analysisJson
            ? JSON.parse(job.analysisJson as unknown as string)
            : null;
        } catch {
          parsedAnalysis = null;
        }

        return {
          ...job,
          analysisJson: parsedAnalysis,
        };
      });

      const sorted = [...normalized].sort(
        (a, b) =>
          new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(),
      );
      setJobs(sorted);

      if (selectedJob) {
        const updatedSelected =
          sorted.find((job) => job.id === selectedJob.id) ?? null;
        setSelectedJob(updatedSelected);

        if (updatedSelected && updatedSelected.analysisJson) {
          setSelectedAnalysis(updatedSelected.analysisJson);
        } else {
          setSelectedAnalysis(null);
        }
      }
    } catch (error) {
      console.error("Failed to load jobs list", error);
    } finally {
      setIsLoadingJobs(false);
    }
  };

  useEffect(() => {
    loadJobs();
  }, []);

  useEffect(() => {
    const hasProcessing = jobs.some((job) => job.status === "processing");
    const now = Date.now();
    const withinRecentUploadWindow =
      lastUploadAt !== null && now - lastUploadAt < 30000;

    if (!hasProcessing && !withinRecentUploadWindow) {
      return;
    }

    const intervalId = window.setInterval(() => {
      loadJobs();
    }, 5000);

    return () => {
      window.clearInterval(intervalId);
    };
  }, [jobs, lastUploadAt]);

  const handleSelectJob = (jobId: string) => {
    setIsDetailsLoading(false);
    setDetailsError(null);
    setSelectedAnalysis(null);

    const jobFromList = jobs.find((job) => job.id === jobId) ?? null;
    if (jobFromList) {
      setSelectedJob(jobFromList);
    } else {
      setSelectedJob(null);
      return;
    }
    const parseAnalysis = (job: Job) => {
      if (!job.analysisJson) {
        setSelectedAnalysis(null);
        return;
      }

      setSelectedAnalysis(job.analysisJson);
    };

    parseAnalysis(jobFromList);
  };

  const handleCloseDetails = () => {
    setSelectedJob(null);
    setSelectedAnalysis(null);
    setDetailsError(null);
    setIsDetailsLoading(false);
  };

  const handleRunAnalysis = async () => {
    if (!file) {
      setStatus("Please upload a file before running the analysis.");
      return;
    }

    setStatus("Uploading your recording and starting the analysis...");
    setIsUploading(true);

    const formData = new FormData();
    formData.append("file", file);

    try {
      const response = await fetch(`${API_BASE_URL}/process-file`, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) {
        setStatus(
          "Upload failed. The server could not process this recording. Please check your internet connection and that the audio file is a supported type, then try again.",
        );
        return;
      }

      const data: { success?: boolean } = await response.json();

      if (data && data.success) {
        setStatus(
          "File uploaded successfully. Analysis has started - this may take a few minutes. Check the Recent Calls list for status updates.",
        );
        setLastUploadAt(Date.now());
        loadJobs();
      } else {
        setStatus(
          "Upload failed. The server did not accept this recording. Please try again with a different file.",
        );
      }
    } catch (error) {
      console.error("Error uploading or processing file", error);
      setStatus(
        "Upload failed due to a network or server error. Please check your connection and try again.",
      );
    } finally {
      setIsUploading(false);
    }
  };

  const renderJobCard = (job: Job) => (
    <li
      key={job.id}
      className={`cursor-pointer rounded-2xl border border-[#1F2933] bg-[#050B1F] p-4 md:p-5 transition hover:border-[#00C8FF]/60 hover:bg-[#050B1F]/90 ${
        selectedJob && selectedJob.id === job.id
          ? "border-[#00C8FF] bg-[#050B1F]/90"
          : "border-[#1F2933] bg-[#050B1F]"
      }`}
    >
      <div className="flex flex-wrap items-center justify-between gap-2">
        <div className="text-sm font-medium text-[#F9FAFB]">
          {job.filename}
        </div>
        <span className={getStatusBadgeClasses(job.status)}>
          {job.status}
        </span>
      </div>
      <div className="text-xs text-[#9CA3AF]">
        Status: {job.status} -{" "}
        {new Date(job.createdAt).toLocaleString()}
      </div>
      {job.status === "done" && (
        <p className="mt-1 text-sm text-[#9CA3AF]">
          Call summary is ready â€“ click "View details".
        </p>
      )}
      <button
        type="button"
        onClick={(event) => {
          event.stopPropagation();
          handleSelectJob(job.id);
        }}
        className="mt-2 text-xs font-medium text-[#00C8FF] hover:text-[#00A0D4] hover:underline"
      >
        View details
      </button>
    </li>
  );

  return (
    <div className="min-h-screen bg-[#020817] text-[#F9FAFB]">
      <div className="mx-auto max-w-3xl px-4 pt-6 pb-10 md:py-12">
        <header className="mb-8 text-center">
          <h1 className="mb-3 text-3xl font-extrabold tracking-tight text-[#00C8FF] md:text-4xl">
            Discovery Call Automation
          </h1>
          <p className="text-base text-[#F9FAFB] md:text-lg">
            <span>Upload a call recording and let </span>
            <span className="font-semibold text-[#F9FAFB]">Kalyan</span>{" "}
            <span className="font-semibold text-[#00C8FF]">AI</span>{" "}
            <span>analyse it.</span>
          </p>
        </header>

        <div className="mt-4">
          <div className="rounded-[32px] bg-gradient-to-b from-[#00C8FF]/25 via-[#00C8FF]/10 to-transparent p-[1px] shadow-[0_0_55px_rgba(0,200,255,0.28)]">
            <section className="space-y-4 md:space-y-6 rounded-[30px] bg-[#050B1F] border border-slate-800/70 px-6 py-4 md:px-8 md:py-8">
              <div>
                <label
                  htmlFor="recording"
                  className="mb-2 block text-sm font-medium text-[#00C8FF]"
                >
                  Upload recording
                </label>
                <div className="mt-3 flex flex-col items-center justify-center gap-2 text-center md:flex-row md:items-center md:justify-start md:text-left">
                  <input
                    id="recording"
                    type="file"
                    onChange={(event) => {
                      const selectedFile = event.target.files?.[0] ?? null;
                      setFile(selectedFile);
                    }}
                    className="block w-full cursor-pointer text-sm text-[#F9FAFB] file:mr-4 file:cursor-pointer file:rounded-lg file:border file:border-[#1F2933] file:bg-[#050B1F] file:px-4 file:py-2 file:text-sm file:font-medium file:text-[#F9FAFB] hover:file:bg-[#050B1F]/90 md:w-auto"
                  />
                  <span className="inline-block max-w-[220px] truncate text-sm text-slate-300 md:max-w-none">
                    {file ? file.name : "No file selected"}
                  </span>
                </div>
              </div>

              <div className="flex flex-col items-stretch gap-3 sm:flex-row sm:items-center">
                <button
                  type="button"
                  onClick={handleRunAnalysis}
                  disabled={isUploading}
                  className="inline-flex flex-1 items-center justify-center rounded-full bg-[#00C8FF] px-6 py-2.5 text-sm font-semibold text-[#F9FAFB] shadow-lg shadow-[#00C8FF]/40 hover:bg-[#00A0D4] active:bg-[#00A0D4] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#00C8FF] focus-visible:ring-offset-2 focus-visible:ring-offset-[#020817] disabled:cursor-not-allowed disabled:opacity-60 sm:flex-none"
                >
                  {isUploading ? "Running analysis..." : "Run Analysis"}
                </button>

                <button
                  type="button"
                  onClick={loadJobs}
                  className="inline-flex items-center justify-center rounded-full border border-[#1F2933] px-4 py-2 text-sm font-medium text-[#F9FAFB] hover:bg-[#050B1F]"
                >
                  Refresh
                </button>
              </div>

          <p
            className={`text-sm ${statusMessage === "Idle - waiting for a recording." ? "text-[#00C8FF]" : "text-[#9CA3AF]"}`}
            data-testid="discovery-status"
          >
            {statusMessage}
          </p>

          <div className="mt-8 grid gap-6 md:grid-cols-2">
            <section>
              <div className="mb-3 flex items-center justify-between gap-2">
                <h2 className="text-xl font-semibold text-[#F9FAFB]">
                  Recent Calls
                </h2>
                {jobs.length > 0 && (
                  <button
                    type="button"
                    onClick={() => setShowHistory((prev) => !prev)}
                    className="text-xs font-medium text-[#F9FAFB] hover:text-[#E5E7EB] underline-offset-2 hover:underline"
                  >
                    {showHistory ? "Hide previous calls" : "Show previous calls"}
                  </button>
                )}
              </div>
              {showHistory ? (
                jobs.length === 0 ? (
                  <p className="text-sm text-[#9CA3AF]">
                    No recent calls yet.
                  </p>
                ) : (
                  <ul className="space-y-3">
                    {jobs.map((job) => renderJobCard(job))}
                  </ul>
                )
              ) : jobs.length === 0 ? (
                <div className="rounded-2xl border border-[#1F2933] bg-[#050B1F]/80 p-4 md:p-5">
                  <p className="text-sm text-[#9CA3AF]">
                    Upload a file to start analysis.
                  </p>
                  <p className="mt-1 text-xs text-[#6B7280]">
                    Current time: {new Date().toLocaleString()}
                  </p>
                </div>
              ) : (
                <ul className="space-y-3">
                  {renderJobCard(jobs[0])}
                </ul>
              )}
            </section>

            <section className="rounded-xl border border-[#1F2933] bg-[#050B1F] p-4 md:p-5">
              <h2 className="mb-3 text-xl font-semibold text-[#00C8FF]">
                Call Details
              </h2>
              {selectedJob === null ? (
                <p className="text-sm text-[#9CA3AF]">
                  Select a call to see full analysis.
                </p>
              ) : (
                <div className="space-y-3 text-sm">
                  <div className="space-y-1">
                    <div>
                      <span className="font-semibold text-[#00C8FF]">
                        Filename:
                      </span>{" "}
                      {selectedJob.filename}
                    </div>
                    <div>
                      <span className="font-semibold text-[#00C8FF]">
                        Status:
                      </span>{" "}
                      {selectedJob.status}
                    </div>
                    <div>
                      <span className="font-semibold text-[#00C8FF]">
                        Created at:
                      </span>{" "}
                      {new Date(selectedJob.createdAt).toLocaleString()}
                    </div>
                    {selectedJob.resultSummary && (
                      <p className="mt-2 text-sm text-slate-300">
                        <span className="font-semibold text-[#00C8FF]">
                          Summary:
                        </span>{" "}
                        {selectedJob.resultSummary}
                      </p>
                    )}
                    <p className="mt-1 text-sm text-slate-300">
                      <span className="font-semibold text-[#00C8FF]">
                        Email status:
                      </span>{" "}
                      {selectedJob.emailStatus === "sent"
                        ? "Summary sent to future@kalyanai.io."
                        : selectedJob.emailStatus === "error"
                        ? "There was an error sending the summary email. Please check the logs."
                        : "Will be sent automatically when analysis is complete."}
                    </p>
                  </div>

                  {isDetailsLoading && (
                    <p className="text-sm text-[#9CA3AF]">
                      Loading call details...
                    </p>
                  )}

                  {detailsError && !isDetailsLoading && (
                    <p className="text-sm text-red-400">{detailsError}</p>
                  )}

                  {selectedAnalysis && !isDetailsLoading && !detailsError && (
                    <div className="space-y-3">
                      {[
                        { label: "Top priority", key: "TOP_PRIORITY" },
                        { label: "Key outcomes", key: "KEY_OUTCOMES" },
                        { label: "Automations", key: "AUTOMATIONS_LIST" },
                        { label: "Revenue ideas", key: "REVENUE_IDEAS" },
                        { label: "Next steps", key: "NEXT_STEPS" },
                      ].map((field) => {
                        const value =
                          (selectedAnalysis as Record<string, unknown>)[
                            field.key
                          ];
                        const textValue =
                          typeof value === "string" ? value.trim() : "";

                        if (!textValue) {
                          return null;
                        }

                        const lines = textValue.split("\n").filter((line) =>
                          line.trim(),
                        );

                          return (
                            <div key={field.key}>
                              <h3 className="mt-4 mb-1 text-xs font-semibold uppercase tracking-wide text-[#00C8FF]">
                                {field.label}
                              </h3>
                              <ul className="mt-1 space-y-1 text-sm text-[#F9FAFB]">
                                {lines.map((line, index) => (
                                  <li key={index} className="leading-snug">
                                    {line.replace(/^-+\s*/, "")}
                                  </li>
                                ))}
                              </ul>
                            </div>
                          );
                      })}
                    </div>
                  )}

                  {!isDetailsLoading &&
                    !detailsError &&
                    !selectedAnalysis &&
                    selectedJob &&
                    !selectedJob.analysisJson && (
                      <p className="text-sm text-[#9CA3AF]">
                        Analysis is not available yet for this call.
                      </p>
                    )}

                  {!isDetailsLoading &&
                    !detailsError &&
                    !selectedAnalysis &&
                    selectedJob &&
                    selectedJob.analysisJson && (
                      <p className="text-sm text-[#9CA3AF]">
                        No analysis JSON available for this call.
                      </p>
                    )}

                  <button
                    type="button"
                    onClick={handleCloseDetails}
                    className="mt-3 inline-flex items-center justify-center rounded-md border border-[#1F2933] px-3 py-1.5 text-xs font-medium text-[#F9FAFB] hover:bg-[#050B1F]"
                  >
                    Close
                  </button>
                </div>
              )}
            </section>
          </div>
        </section>
          </div>
        </div>
      </div>
    </div>
  );
}
